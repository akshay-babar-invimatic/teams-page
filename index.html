<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Teams Personal App - Widget Token</title>
  <style>
    body { font-family: Arial; text-align:center; padding:50px; }
    input { width: 300px; padding: 5px; margin-top: 10px; }
    button { padding: 8px 15px; margin-left: 5px; }
    iframe { 
      width: 80%; 
      height: 400px; 
      margin-top: 20px; 
      border: 1px solid #ccc; 
      display: none; 
      overflow: auto;
    }
  </style>
</head>
<body>
  <h2>Enter Widget URL</h2>
  <input type="text" id="widgetUrl" placeholder="Enter widget URL here" />
  <button id="saveBtn">Save & Generate Token</button>
  <p id="status"></p>

  <iframe id="widgetFrame" scrolling="yes"></iframe>

  <!-- Load MSAL.js and Teams SDK -->
  <script src="https://alcdn.msauth.net/browser/2.37.0/js/msal-browser.min.js"></script>
  <script src="https://res.cdn.office.net/teams-js/2.18.0/js/MicrosoftTeams.min.js"></script>
  <script>
    const clientId = "f06fbb6a-9b84-4371-ae9b-9e18c37e8d40";
    const redirectUri = "https://akshay-babar-invimatic.github.io/teams-page/";
    const graphScopes = ["User.ReadWrite", "offline_access"];

    // MSAL config
    const msalInstance = new msal.PublicClientApplication({
      auth: { clientId, authority: "https://login.microsoftonline.com/common", redirectUri },
      cache: { cacheLocation: "sessionStorage", storeAuthStateInCookie: false }
    });

    document.getElementById("saveBtn").onclick = async () => {
      const widgetUrl = document.getElementById("widgetUrl").value.trim();
      if (!widgetUrl) return alert("Please enter a widget URL");

      document.getElementById("status").innerText = "Initializing Teams SSO...";
      
      // Step 1: Initialize Teams SDK and get SSO token
      microsoftTeams.app.initialize().then(() => {
        microsoftTeams.authentication.getAuthToken({
          resources: [`api://${redirectUri}${clientId}`],
          successCallback: async (ssoToken) => {
            console.log("✅ Teams SSO token:", ssoToken);

            // Step 2: Exchange SSO token for Graph token using MSAL
            try {
              let account = msalInstance.getAllAccounts()[0];
              let tokenResponse;

              if (account) {
                try {
                  tokenResponse = await msalInstance.acquireTokenSilent({ scopes: graphScopes, account });
                } catch (silentErr) {
                  console.warn("Silent token failed, using popup:", silentErr);
                  tokenResponse = await msalInstance.acquireTokenPopup({ scopes: graphScopes });
                }
              } else {
                // No account, force login popup
                await msalInstance.loginPopup({ scopes: graphScopes, prompt: "consent" });
                account = msalInstance.getAllAccounts()[0];
                tokenResponse = await msalInstance.acquireTokenSilent({ scopes: graphScopes, account });
              }

              console.log("✅ Graph token:", tokenResponse.accessToken);

              // Step 3: Render widget
              const iframe = document.getElementById("widgetFrame");
              iframe.src = widgetUrl;
              iframe.style.display = "block";

              document.getElementById("status").innerText = "✅ Token generated & widget rendered!";
            } catch (msalError) {
              console.error("❌ Graph token error:", msalError);
              document.getElementById("status").innerText = "❌ Error generating Graph token. Check console.";
            }
          },
          failureCallback: (err) => {
            console.error("❌ Teams SSO failed:", err);
            document.getElementById("status").innerText = "❌ Teams SSO failed. Check console.";
          }
        });
      });
    };
  </script>
</body>
</html>
