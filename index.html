<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Teams Personal Widget Embedder122</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://res.cdn.office.net/teams-js/2.15.0/js/MicrosoftTeams.min.js"></script>
  <style>
    :root {
      --teams-bg: #f3f5f8;
      --teams-primary: #22c55e; /* green */
      --teams-border: #e0e0e0;
      --font-family: 'Inter', sans-serif;
    }
    html, body { height: 100%; margin: 0; padding: 0; }
    body {
      font-family: var(--font-family);
      background-color: var(--teams-bg);
      overflow: hidden;
    }
    .app-container { display: flex; flex-direction: column; height: 100%; padding: 1rem; }
    .input-bar {
      background-color: white; padding: 0.75rem 1rem; border-radius: 0.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 1rem;
      display: flex; align-items: center; flex-shrink: 0;
    }
    .widget-iframe {
      flex-grow: 1; width: 100%; border: 1px solid var(--teams-border);
      border-radius: 0.5rem; background-color: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05); height: 100%;
    }
    .loading-overlay {
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.8);
      display: flex; justify-content: center; align-items: center;
      z-index: 10; border-radius: 0.5rem; flex-direction: column;
    }
  </style>
</head>
<body>
  <div class="app-container" id="app">
    <div class="input-bar">
      <label for="urlInput" class="text-sm font-medium text-gray-700 mr-3 hidden sm:block">Widget URL:</label>
      <input id="urlInput" type="url"
        placeholder="Enter a secure (https://) widget URL..."
        class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-teams-primary focus:border-teams-primary text-sm"
      >
      <button id="loadButton"
  class="ml-3 bg-[#464EB8] hover:bg-[#3b429a] text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out shadow-md"
>
  Save
</button>
    </div>

    <div class="relative flex-grow">
      <iframe id="widgetIframe" class="widget-iframe" frameborder="0"></iframe>
      <div id="statusOverlay" class="loading-overlay">
        <div id="statusMessage" class="text-gray-500 text-center p-4">
          <p class="font-bold text-xl mb-2">Welcome!</p>
          <p>Fetching your widget...</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const BASE_URL = "https://api.concept.theloops.ai/api/v1/widget-config";
    const widgetIframe = document.getElementById("widgetIframe");
    const urlInput = document.getElementById("urlInput");
    const loadButton = document.getElementById("loadButton");
    const statusOverlay = document.getElementById("statusOverlay");
    const statusMessage = document.getElementById("statusMessage");

    let userId = null;
    let userEmail = null;

    // ---- Initialize Teams SDK ----
    async function initTeams() {
      console.log("üü¶ Initializing Microsoft Teams SDK...");
      try {
        await microsoftTeams.app.initialize();
        const context = await microsoftTeams.app.getContext();
        userId = context.user?.id || context.userObjectId || "unknown_user";
        userEmail = context.user?.userPrincipalName || context.user?.loginHint || "unknown_email";
        console.log("‚úÖ Teams initialized successfully");
        console.log("üë§ User ID:", userId);
        console.log("üìß User Email:", userEmail);
        await fetchWidgetConfig();
      } catch (err) {
        console.error("‚ùå Teams init failed:", err);
        statusMessage.innerHTML = "<p>Unable to load Teams context.</p>";
      }
    }

    // ---- Always fetch widget config from backend ----
    async function fetchWidgetConfig() {
      console.log(`üåê Calling GET API: ${BASE_URL}/${userId}`);
      try {
        const res = await fetch(`${BASE_URL}/${userId}`, {
          method: "GET",
          headers: { "Content-Type": "application/json", "accept": "application/json" }
        });
        console.log("üì• API Response Status:", res.status);
        const data = await res.json();
        console.log("üì¶ API Response JSON:", data);

        if (data.responseCode === 200 && data.widgetConfigMetadata?.metaData) {
          const meta = JSON.parse(data.widgetConfigMetadata.metaData);
          console.log("üß© Extracted metadata:", meta);
          if (meta.widgetUrl) {
            console.log("‚úÖ Widget URL found:", meta.widgetUrl);
            renderWidget(meta.widgetUrl);
            return;
          }
        }
        showInputPrompt();
      } catch (e) {
        console.error("‚ùå Fetch failed:", e);
        showInputPrompt();
      }
    }

    // ---- Create new widget config ----
    async function createWidgetConfig(widgetUrl) {
      console.log("üü¢ Calling POST API to create widget config...");
      const payload = {
        userExternalId: userId,
        emailId: userEmail,
        metaData: JSON.stringify({ widgetUrl })
      };
      console.log("üì§ POST Payload:", payload);

      try {
        const res = await fetch(BASE_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        console.log("üì• POST API Response Status:", res.status);
        const data = await res.json();
        console.log("üì¶ POST API Response JSON:", data);
      } catch (e) {
        console.error("‚ùå POST API failed:", e);
      }
    }

    // ---- Update existing widget config ----
    async function updateWidgetConfig(widgetUrl) {
      console.log("üü° Calling PUT API to update widget config...");
      const payload = { metaData: JSON.stringify({ widgetUrl }) };
      console.log("üì§ PUT Payload:", payload);

      try {
        const res = await fetch(`${BASE_URL}/${userId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        console.log("üì• PUT API Response Status:", res.status);
        const data = await res.json();
        console.log("üì¶ PUT API Response JSON:", data);
      } catch (e) {
        console.error("‚ùå PUT API failed:", e);
      }
    }

    // ---- Render iframe ----
    function renderWidget(url) {
      console.log("üñºÔ∏è Rendering widget iframe with base URL:", url);
      const finalUrl = `${url}${url.includes("?") ? "&" : "?"}userExternalId=${encodeURIComponent(userId)}`;
      console.log("üîó Final widget URL with query param:", finalUrl);

      urlInput.value = url;
      widgetIframe.src = finalUrl;
      statusOverlay.classList.add("hidden");
      console.log("‚úÖ Widget rendered successfully.");
    }

    // ---- Show input prompt ----
    function showInputPrompt() {
      console.log("üí¨ Prompting user to enter widget URL...");
      statusOverlay.classList.remove("hidden");
      statusMessage.innerHTML = `
        <p class="font-bold text-xl mb-2">Setup Required</p>
        <p>Enter your widget URL above and click <b>Save & Render</b>.</p>
      `;
    }

    // ---- Button click handler ----
    loadButton.addEventListener("click", async () => {
      console.log("üñ±Ô∏è Save & Render button clicked.");
      const newUrl = urlInput.value.trim();
      if (!newUrl.startsWith("https://")) {
        console.warn("‚ö†Ô∏è Invalid URL entered:", newUrl);
        alert("Please enter a valid secure (https) URL.");
        return;
      }

      console.log("üîÑ Updating backend with new widget URL...");
      await updateWidgetConfig(newUrl);
      renderWidget(newUrl);
    });

    // ---- Load on page ready ----
    initTeams();
  </script>
</body>
</html>
