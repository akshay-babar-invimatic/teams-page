<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teams Personal Widget Loader</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://res.cdn.office.net/teams-js/2.16.0/js/MicrosoftTeams.min.js"></script>
  <style>
    :root {
      --teams-bg: #f3f5f8;
      --teams-primary: #6264a7;
      --teams-border: #e0e0e0;
      --font-family: 'Inter', sans-serif;
    }
    html, body { height: 100%; margin: 0; padding: 0; }
    body {
      font-family: var(--font-family);
      background-color: var(--teams-bg);
      overflow: hidden;
    }
    .app-container {
      display: flex;
      flex-direction: column;
      height: 100%;
      padding: 1rem;
    }
    .input-bar {
      background-color: white;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      flex-shrink: 0;
    }
    .widget-iframe {
      flex-grow: 1;
      width: 100%;
      border: 1px solid var(--teams-border);
      border-radius: 0.5rem;
      background-color: white;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      height: 100%;
    }
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10;
      border-radius: 0.5rem;
      flex-direction: column;
    }
  </style>
</head>
<body>
  <div class="app-container" id="app">
    <div class="input-bar">
      <label for="urlInput" class="text-sm font-medium text-gray-700 mr-3 hidden sm:block">Widget URL:</label>
      <input type="url" id="urlInput" placeholder="Enter widget URL..." class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-teams-primary focus:border-teams-primary transition duration-150 ease-in-out text-sm">
      <button id="loadButton" class="ml-3 bg-teams-primary hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out shadow-md disabled:opacity-50" onclick="saveAndLoadWidget()">Load Widget</button>
    </div>

    <div class="relative flex-grow">
      <iframe id="widgetIframe" class="widget-iframe" frameborder="0"></iframe>
      <div id="statusOverlay" class="loading-overlay">
        <div id="statusMessage" class="text-gray-500 text-center p-4">
          <p class="font-bold text-xl mb-2">Welcome!</p>
          <p>Enter a widget URL and click 'Load Widget'.</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const proxyPrefix = "https://corsproxy.io/?"; // temporary CORS bypass
    const apiBase = "https://api.concept.theloops.ai/api/v1/widget-config";
    const widgetIframe = document.getElementById("widgetIframe");
    const urlInput = document.getElementById("urlInput");
    const statusOverlay = document.getElementById("statusOverlay");
    const statusMessage = document.getElementById("statusMessage");

    let userId = "";
    let userEmail = "";

    // --- Teams SDK initialization ---
    microsoftTeams.app.initialize().then(() => {
      microsoftTeams.app.getContext().then(async (context) => {
        userId = context.user.id || "demoUser001";
        userEmail = context.user.userPrincipalName || "demo@example.com";

        console.log("üë§ Teams User:", userId, userEmail);
        await loadWidgetFromCacheOrAPI();
      });
    });

    // --- Load widget from cache or API ---
    async function loadWidgetFromCacheOrAPI() {
      console.log("üîç Checking local cache for widget URL...");
      const cachedUrl = localStorage.getItem(`widgetUrl_${userId}`);

      if (cachedUrl) {
        console.log("‚úÖ Found in cache:", cachedUrl);
        renderWidget(cachedUrl);
      } else {
        console.log("‚ö†Ô∏è Cache miss! Fetching from API...");
        await fetchWidgetConfig();
      }
    }

    // --- Fetch widget config from backend ---
    async function fetchWidgetConfig() {
      const apiUrl = `${apiBase}/${userId}`;
      const fullUrl = proxyPrefix + encodeURIComponent(apiUrl);

      console.log("üåê Calling GET API via proxy:", fullUrl);
      try {
        const res = await fetch(fullUrl);
        const data = await res.json();
        console.log("üì¶ API Response:", data);

        if (data?.responseCode === 200 && data.widgetConfigMetadata) {
          const meta = JSON.parse(data.widgetConfigMetadata.metaData || "{}");
          const widgetUrl = meta.widgetUrl || meta.layout || null;
          console.log("üéØ Extracted Widget URL:", widgetUrl);

          if (widgetUrl) {
            localStorage.setItem(`widgetUrl_${userId}`, widgetUrl);
            renderWidget(widgetUrl);
          } else {
            console.log("‚ö†Ô∏è No widget URL found in metadata.");
          }
        } else {
          console.warn("‚ö†Ô∏è API response invalid or missing data.");
        }
      } catch (err) {
        console.error("‚ùå Fetch failed:", err);
        statusMessage.innerHTML = "<p>Failed to fetch widget config.</p>";
      }
    }

    // --- Save or update widget URL ---
    async function saveAndLoadWidget() {
      const newUrl = urlInput.value.trim();
      if (!newUrl) {
        console.warn("‚ö†Ô∏è No URL entered.");
        return;
      }

      console.log("üìù Saving new widget URL:", newUrl);
      const cachedUrl = localStorage.getItem(`widgetUrl_${userId}`);

      const apiUrl = `${apiBase}/${userId}`;
      const fullUrl = proxyPrefix + encodeURIComponent(apiUrl);
      const payload = { metaData: JSON.stringify({ widgetUrl: newUrl }) };

      const method = cachedUrl ? "PUT" : "POST";
      console.log(`üåê Calling ${method} API via proxy:`, fullUrl);
      console.log("üì® Request Payload:", payload);

      try {
        const res = await fetch(fullUrl, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        console.log("üì¶ API Response:", data);

        if (res.ok) {
          localStorage.setItem(`widgetUrl_${userId}`, newUrl);
          renderWidget(newUrl);
          console.log("‚úÖ Widget URL saved and rendered successfully.");
        } else {
          console.error("‚ùå API error:", data);
        }
      } catch (err) {
        console.error("‚ùå Failed to save widget:", err);
      }
    }

    // --- Render widget ---
    function renderWidget(url) {
      console.log("üß© Rendering widget:", url);
      widgetIframe.src = url;
      statusOverlay.classList.add("hidden");
    }
  </script>
</body>
</html>
